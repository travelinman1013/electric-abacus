<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electric Abacus - System Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .architecture-layer {
            margin-bottom: 40px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .architecture-layer:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .layer-header {
            padding: 20px 30px;
            color: white;
            font-size: 1.4em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .layer-content {
            padding: 30px;
            background: white;
        }

        .frontend { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .firebase { background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); }
        .domain { background: linear-gradient(135deg, #26C6DA 0%, #00ACC1 100%); }
        .data { background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); }
        .security { background: linear-gradient(135deg, #EF5350 0%, #E53935 100%); }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .component {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .component:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .component h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component ul {
            list-style: none;
            padding-left: 0;
        }

        .component li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            color: #555;
            font-size: 0.95em;
        }

        .component li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .flow-diagram {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .flow-number {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .flow-arrow {
            text-align: center;
            color: #667eea;
            font-size: 1.5em;
            margin: 10px 0;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 15px 0;
        }

        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
            margin: 15px 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .icon {
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .component-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Electric Abacus</h1>
        <div class="subtitle">Full System Architecture Documentation</div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('dataflow')">Data Flow</button>
            <button class="tab" onclick="showTab('security')">Security</button>
        </div>

        <div id="overview" class="tab-content active">
            <!-- FRONTEND LAYER -->
            <div class="architecture-layer">
                <div class="layer-header frontend">
                    <span>üé® FRONTEND LAYER</span>
                    <span>React SPA (Vite)</span>
                </div>
                <div class="layer-content">
                    <h2>Provider Hierarchy</h2>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-number">1</div>
                            <div>
                                <strong>QueryClientProvider</strong> (React Query)
                                <div style="color: #666; font-size: 0.9em;">Server state management + caching</div>
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">2</div>
                            <div>
                                <strong>AuthProvider</strong>
                                <div style="color: #666; font-size: 0.9em;">Firebase Auth, User Profile, Methods: signIn, signUp, signOut</div>
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">3</div>
                            <div>
                                <strong>PreferencesProvider</strong>
                                <div style="color: #666; font-size: 0.9em;">User UI preferences & theme settings</div>
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">4</div>
                            <div>
                                <strong>BusinessProvider</strong>
                                <div style="color: #666; font-size: 0.9em;">Custom claims, businessId + role, exponential backoff polling</div>
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">5</div>
                            <div>
                                <strong>App</strong>
                                <div style="color: #666; font-size: 0.9em;">Routes + Components</div>
                            </div>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">React Query Hooks</h2>
                    <div class="component-grid">
                        <div class="component">
                            <h3>üìä Data Queries</h3>
                            <ul>
                                <li>useWeeks() ‚Üí list all weeks</li>
                                <li>useWeek(weekId) ‚Üí get specific week</li>
                                <li>useIngredients() ‚Üí list ingredients</li>
                                <li>useMenuItems() ‚Üí list menu items</li>
                                <li>useWeekInventory(weekId)</li>
                                <li>useWeekSales(weekId)</li>
                                <li>useWeekReport(weekId)</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>‚úèÔ∏è Mutations</h3>
                            <ul>
                                <li>useSaveWeekInventory()</li>
                                <li>useFinalizeWeek()</li>
                                <li>useCreateIngredient()</li>
                                <li>useUpdateMenuItems()</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>üîê Automatic Scoping</h3>
                            <ul>
                                <li>All hooks use: useBusiness()</li>
                                <li>businessId automatically injected</li>
                                <li>Complete data isolation</li>
                                <li>No manual tenant filtering needed</li>
                            </ul>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Firestore Service Layer</h2>
                    <div class="highlight">
                        <strong>All queries scoped to:</strong> <code>/businesses/{businessId}/{collection}</code>
                    </div>
                    <div class="component-grid">
                        <div class="component">
                            <h3>üìÅ Core Services</h3>
                            <ul>
                                <li>listWeeks(businessId)</li>
                                <li>getWeek(businessId, weekId)</li>
                                <li>saveWeekSales(businessId, weekId, data)</li>
                                <li>finalizeWeek(businessId, weekId)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FIREBASE LAYER -->
            <div class="architecture-layer">
                <div class="layer-header firebase">
                    <span>üî• FIREBASE SERVICES</span>
                    <span>Backend Infrastructure</span>
                </div>
                <div class="layer-content">
                    <div class="component-grid">
                        <div class="component">
                            <h3>üîê Firebase Auth</h3>
                            <ul>
                                <li>User Management</li>
                                <li>Email/Password Authentication</li>
                                <li>Custom Claims (businessId, role)</li>
                                <li>JWT Token with claims</li>
                                <li>getIdTokenResult() for claims</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>üì¶ Cloud Firestore</h3>
                            <ul>
                                <li>Multi-tenant data structure</li>
                                <li>/users/{uid}</li>
                                <li>/businesses/{businessId}</li>
                                <li>Sub-collections: ingredients, menuItems, weeks</li>
                                <li>Week sub-collections: sales, inventory, snapshots, report</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>‚ö° Cloud Functions</h3>
                            <ul>
                                <li>setupNewBusinessAccountCallable</li>
                                <li>onUserCreate trigger</li>
                                <li>Workflow: Validate ‚Üí Create Biz ‚Üí Create User ‚Üí Set Claims</li>
                            </ul>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Firestore Security Rules</h2>
                    <div class="code-block">
match /businesses/{businessId}/{document=**} {
  allow read, write: if request.auth != null &&
                        request.auth.token.businessId == businessId;
}

<span style="color: #50fa7b;">// Enforces:</span>
<span style="color: #50fa7b;">// ‚úì Data isolation per business</span>
<span style="color: #50fa7b;">// ‚úì Validates businessId in custom claims</span>
<span style="color: #50fa7b;">// ‚úì Role-based restrictions (owner vs teamMember)</span>
                    </div>
                </div>
            </div>

            <!-- DOMAIN LAYER -->
            <div class="architecture-layer">
                <div class="layer-header domain">
                    <span>üßÆ DOMAIN LAYER</span>
                    <span>Pure Business Logic (TypeScript)</span>
                </div>
                <div class="layer-content">
                    <div class="highlight">
                        <span class="badge">‚úì Zero Dependencies</span>
                        <span class="badge">‚úì Framework Agnostic</span>
                        <span class="badge">‚úì 99% Test Coverage</span>
                        <span class="badge">‚úì Pure Functions</span>
                    </div>

                    <div class="component-grid">
                        <div class="component">
                            <h3>üìä Core Calculations</h3>
                            <ul>
                                <li>computeUsage(entry)</li>
                                <li>calculateIngredientCost()</li>
                                <li>calculateRecipeCost()</li>
                                <li>calculateWeeklyTotals()</li>
                                <li>computeProfitMargins()</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>üîÑ Workflow Functions</h3>
                            <ul>
                                <li>finalizeWeekProcess()</li>
                                <li>generateWeekReport()</li>
                                <li>snapshotIngredientCosts()</li>
                                <li>validateInventoryData()</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>üìà Analytics</h3>
                            <ul>
                                <li>aggregateWeeklySales()</li>
                                <li>computeCOGS()</li>
                                <li>calculateGrossProfit()</li>
                                <li>generateBreakdown()</li>
                            </ul>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Key Formula</h2>
                    <div class="code-block">
<span style="color: #50fa7b;">// Usage Calculation</span>
usage = beginningInventory + received - endingInventory

<span style="color: #50fa7b;">// Ingredient Cost</span>
ingredientCost = usage √ó unitCost

<span style="color: #50fa7b;">// Recipe Cost</span>
recipeCost = Œ£(ingredient.quantity √ó ingredient.unitCost)

<span style="color: #50fa7b;">// Profit Margin</span>
margin = ((sellingPrice - recipeCost) / sellingPrice) √ó 100
                    </div>
                </div>
            </div>
        </div>

        <div id="dataflow" class="tab-content">
            <div class="architecture-layer">
                <div class="layer-header frontend">
                    <span>üîÑ DATA FLOW DIAGRAMS</span>
                </div>
                <div class="layer-content">
                    <h2>1. User Signup & Authentication Flow</h2>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-number">1</div>
                            <div><strong>User submits signup form</strong><br/>Email, password, business details</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">2</div>
                            <div><strong>Firebase Auth creates user</strong><br/>Returns user UID</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">3</div>
                            <div><strong>Cloud Function: setupNewBusinessAccountCallable</strong><br/>Creates business document + sets custom claims</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">4</div>
                            <div><strong>BusinessProvider polls for custom claims</strong><br/>Exponential backoff (up to ~30 seconds)</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">5</div>
                            <div><strong>Claims available</strong><br/>{ businessId: "biz-123", role: "owner" }</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">6</div>
                            <div><strong>App renders with business context</strong><br/>All hooks automatically scoped to businessId</div>
                        </div>
                    </div>

                    <h2 style="margin-top: 40px;">2. Weekly Operations Flow</h2>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-number">1</div>
                            <div><strong>User enters inventory data</strong><br/>Beginning, received, ending for each ingredient</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">2</div>
                            <div><strong>Domain calculates usage</strong><br/>usage = begin + received - end</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">3</div>
                            <div><strong>User enters sales data</strong><br/>Quantity sold per menu item</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">4</div>
                            <div><strong>Domain calculates recipe costs</strong><br/>Real-time cost calculations using current prices</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">5</div>
                            <div><strong>User finalizes week</strong><br/>Triggers finalizeWeek mutation</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">6</div>
                            <div><strong>Domain generates report</strong><br/>Snapshots costs, calculates totals, profit margins</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">7</div>
                            <div><strong>Report saved to Firestore</strong><br/>Week status changes to 'finalized'</div>
                        </div>
                    </div>

                    <h2 style="margin-top: 40px;">3. Real-time Recipe Costing</h2>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-number">1</div>
                            <div><strong>User updates ingredient price</strong><br/>e.g., ground beef: $4.50 ‚Üí $5.00</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">2</div>
                            <div><strong>React Query invalidates cache</strong><br/>Triggers refetch of affected data</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">3</div>
                            <div><strong>Domain recalculates all recipe costs</strong><br/>Using updated ingredient prices</div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">4</div>
                            <div><strong>UI updates instantly</strong><br/>New costs, margins displayed across all affected components</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="security" class="tab-content">
            <div class="architecture-layer">
                <div class="layer-header security">
                    <span>üîí MULTI-TENANT SECURITY</span>
                </div>
                <div class="layer-content">
                    <h2>Data Isolation Architecture</h2>
                    
                    <div class="component-grid">
                        <div class="component">
                            <h3>üè¢ Alice's Restaurant (biz-111)</h3>
                            <ul>
                                <li>Owner: Alice (user-aaa)</li>
                                <li>Ingredients: ground-beef, tomatoes</li>
                                <li>Menu Items: burger, salad</li>
                                <li>Weeks: 2025-W39, 2025-W40</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>‚òï Bob's Cafe (biz-222)</h3>
                            <ul>
                                <li>Owner: Bob (user-bbb)</li>
                                <li>Ingredients: coffee-beans, milk</li>
                                <li>Menu Items: latte</li>
                                <li>Weeks: 2025-W39</li>
                            </ul>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Security Enforcement Layers</h2>
                    
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-number">1</div>
                            <div>
                                <strong>JWT Custom Claims</strong><br/>
                                User A: { businessId: "biz-111", role: "owner" }<br/>
                                User B: { businessId: "biz-222", role: "owner" }
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">2</div>
                            <div>
                                <strong>Firestore Security Rules</strong><br/>
                                Validates: request.auth.token.businessId == businessId
                            </div>
                        </div>
                        <div class="flow-arrow">‚Üì</div>
                        <div class="flow-step">
                            <div class="flow-number">3</div>
                            <div>
                                <strong>Frontend Query Scoping</strong><br/>
                                All hooks automatically inject businessId from context
                            </div>
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Access Control Examples</h2>

                    <div class="highlight" style="background: #d4edda; border-left-color: #28a745;">
                        <strong>‚úì ALLOWED:</strong> User A accesses /businesses/biz-111/ingredients/ground-beef
                        <div class="code-block" style="margin-top: 10px;">
JWT: { businessId: "biz-111" }
Rule Check: "biz-111" == "biz-111" ‚Üí ‚úì ALLOW
Result: Returns ground-beef data (Alice's Restaurant only)
                        </div>
                    </div>

                    <div class="highlight" style="background: #f8d7da; border-left-color: #dc3545; margin-top: 20px;">
                        <strong>‚úó DENIED:</strong> User A attempts /businesses/biz-222/ingredients/coffee-beans
                        <div class="code-block" style="margin-top: 10px;">
JWT: { businessId: "biz-111" }
Rule Check: "biz-111" == "biz-222" ‚Üí ‚úó DENY
Result: Permission Error - User A CANNOT access Bob's data
                        </div>
                    </div>

                    <h2 style="margin-top: 30px;">Automatic Query Scoping</h2>
                    <div class="component-grid">
                        <div class="component">
                            <h3>User A's React App</h3>
                            <ul>
                                <li>useBusiness() ‚Üí { businessId: "biz-111" }</li>
                                <li>useIngredients() ‚Üí /businesses/biz-111/ingredients</li>
                                <li>Returns Alice's ingredients ONLY</li>
                            </ul>
                        </div>
                        <div class="component">
                            <h3>User B's React App</h3>
                            <ul>
                                <li>useBusiness() ‚Üí { businessId: "biz-222" }</li>
                                <li>useIngredients() ‚Üí /businesses/biz-222/ingredients</li>
                                <li>Returns Bob's ingredients ONLY</li>
                            </ul>
                        </div>
                    </div>

                    <div class="highlight" style="margin-top: 30px;">
                        <strong>Complete Data Isolation Guaranteed By:</strong><br/>
                        <span class="badge">1. Custom Claims</span>
                        <span class="badge">2. Security Rules</span>
                        <span class="badge">3. Frontend Hooks</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
    </script>
</body>
</html>